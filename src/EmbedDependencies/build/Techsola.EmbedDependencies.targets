<Project>

  <Target Name="Techsola_EmbedDependencies_AddDependenciesAsEmbeddedResources" Condition="'$(EmbedAllDependencies)' == 'true'" AfterTargets="ResolveAssemblyReferences" BeforeTargets="PrepareResources">
    <PropertyGroup>
      <EmbedDependenciesResourcePathPrefix Condition="'$(EmbedDependenciesResourcePathPrefix)' == ''">Assemblies\</EmbedDependenciesResourcePathPrefix>
    </PropertyGroup>
    <ItemGroup>
      <_JoinedFusionNames
        Include="%(Identity)"
        ReferenceCopyLocalPathsIdentity="@(ReferenceCopyLocalPaths->'%(Identity)')"
        FusionName="@(ReferenceCopyLocalPaths->'%(FusionName)')"
        FusionNameFromReferencePath="@(ReferencePath->'%(FusionName)')" />

      <_DependenciesToBecomeEmbeddedResources
        Include="@(_JoinedFusionNames)"
        Condition="'%(ReferenceCopyLocalPathsIdentity)' != '' and '%(FusionName)%(FusionNameFromReferencePath)' != ''"
        AssemblyName="$([System.Text.RegularExpressions.Regex]::Replace($([MSBuild]::ValueOrDefault('%(FusionName)', '%(FusionNameFromReferencePath)')), ',.*', ''))"
        KeepMetadata="x" />

      <EmbeddedResource
        Include="@(_DependenciesToBecomeEmbeddedResources)"
        LogicalName="$(EmbedDependenciesResourcePathPrefix)%(AssemblyName)"
        KeepMetadata="x" />

      <ReferenceCopyLocalPaths Remove="@(ReferenceCopyLocalPaths)" />
    </ItemGroup>
  </Target>

  <Target Name="Techsola_EmbedDependencies_InsertEmbeddedAssemblyResolver" Condition="'$(EmbedAllDependencies)' == 'true'" AfterTargets="CoreCompile">
    <PropertyGroup>
      <TechsolaEmbedDependenciesExe Condition=" '$(MSBuildRuntimeType)' != 'Core' ">$(MSBuildThisFileDirectory)..\tools\net46\Techsola.EmbedDependencies.exe</TechsolaEmbedDependenciesExe>
      <TechsolaEmbedDependenciesExe Condition=" '$(MSBuildRuntimeType)' == 'Core' ">dotnet $(MSBuildThisFileDirectory)..\tools\netcoreapp2.1\Techsola.EmbedDependencies.dll</TechsolaEmbedDependenciesExe>

      <!-- Backslashes before a quote must be doubled to prevent them from escaping the quote -->
      <!-- .NET follows the argv convention: https://docs.microsoft.com/en-us/cpp/cpp/parsing-cpp-command-line-arguments -->
      <_QuotedEmbedDependenciesResourcePathPrefix>"$([System.Text.RegularExpressions.Regex]::Replace('$(EmbedDependenciesResourcePathPrefix)', '(\\+)\Z', '$0$0'))"</_QuotedEmbedDependenciesResourcePathPrefix>
    </PropertyGroup>

    <Exec Command="&quot;$(TechsolaEmbedDependenciesExe)&quot; injectresolver &quot;@(IntermediateAssembly)&quot; $(_QuotedEmbedDependenciesResourcePathPrefix) @(_DependenciesToBecomeEmbeddedResources->'&quot;%(AssemblyName)&quot;', ' ')" />
  </Target>

</Project>
